<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Product">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>The Server Code Explained | Dart: Structured web apps</title>
  <meta property="twitter:account_id" content="376585411" />
  <meta itemprop="name" content="The Server Code Explained | Dart: Structured web apps">
  
  <meta itemprop="image" content="https://www.dartlang.org/imgs/dart-logo-wordmark-1200w.png">
  
  <meta itemprop="description" content="Learn about the appengine APIs used by the server">



<!-- making pagespeed insights happy -->
<style>
@font-face {
  font-family: 'Montserrat';
  font-style: normal;
  font-weight: 400;
  src: url(https://themes.googleusercontent.com/static/fonts/montserrat/v4/zhcz-_WihjSQC0oHJ9TCYL3hpw3pgy2gAi-Ip7WPMi0.woff) format('woff');
}
@font-face {
  font-family: 'Montserrat';
  font-style: normal;
  font-weight: 700;
  src: url(https://themes.googleusercontent.com/static/fonts/montserrat/v4/IQHow_FEYlDC4Gzy_m8fcnbFhgvWbfSbdVg11QabG8w.woff) format('woff');
}
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 300;
  src: url(https://themes.googleusercontent.com/static/fonts/roboto/v10/Hgo13k-tfSpn0qi1SFdUfbO3LdcAZYWl9Si6vvxL-qU.woff) format('woff');
}
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 400;
  src: url(https://themes.googleusercontent.com/static/fonts/roboto/v10/CrYjSnGjrRCn0pd9VQsnFOvvDin1pK8aKteLpeZ5c0A.woff) format('woff');
}
</style>

<link rel='stylesheet' type='text/css' href='/bundles/96e4b278be2e9b94cffcad9b0b04384c.css' />


  
  

  <link rel="alternate" type="application/atom+xml" href="http://news.dartlang.org/feeds/posts/default" title="Atom feed">
  <link href="https://plus.google.com/109866369054280216564" rel="publisher">

  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
  <![endif]-->

  <script>

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-49880327-3', 'dartlang.org');
ga('create', 'UA-26406144-4',
    {'cookieDomain': 'dartlang.org',
     'siteSpeedSampleRate': 50,
     'name': 'dartlangTracker'});

ga('send', 'pageview');
ga('dartlangTracker.send', 'pageview');

</script>


  <script async="" defer="" src="//survey.g.doubleclick.net/async_survey?site=apno2k33xucna4srya26u4i2ri"></script>

</head>
<body onload="prettyPrint()" data-spy="scroll" data-target=".bs-sidebar">

    <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="dart-developer-summit-reg" style="text-align:center;background-color: hsl(172,67%,80%);">
        <a href="/events/2015/summit/">Watch sessions from the first Dart Developer Summit</a>
      </div>
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><i class="sprite-icon-dart-logo"></i></a>
        </div>

        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
           <li class="dropdown">
              <a href="#" class="dropdown=toggle" data-toggle="dropdown">
                Get Started <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">

                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/codelabs/darrrt/">Learn Dart in Minutes</a></li>
                <li><a href="/downloads/">Download Dart</a></li>
              </ul>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    Fundamentals <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/dart-up-and-running/ch02.html">Language Tour</a></li>
                <li><a href="/docs/dart-up-and-running/ch03.html">Library Tour</a></li>
                <li><a href="/docs/">Programmer's Guide</a></li>

                <li class="divider"></li>
                <li><a href="/tools/">Dart Tools</a></li>
                <li><a href="/tools/pub/">Pub Package and Asset Manager</a></li>

                <li class="divider"></li>
                <li><a href="/docs/tutorials/get-started/">Tutorial: Get Started</a></li>
                <li><a href="/docs/tutorials/shared-pkgs/">Tutorial: Packages</a></li>
                <li><a href="/docs/tutorials/futures/">Tutorial: Async</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    Browser<span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/polymer/">Polymer</a></li>
                <li><a href="/codelabs/polymer/">Polymer Code Lab</a></li>
                <li class="divider"></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/tutorials/connect-dart-html/">Tutorial: HTML</a></li>
                <li><a href="/docs/tutorials/polymer-intro/">Tutorial: Polymer</a></li>
                <li><a href="/docs/tutorials/fetchdata/">Tutorial: Forms & Data</a></li>
                <li class="divider"></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/tools/editor/mobile.html">Mobile</a></li>

                <li class="divider"></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/googleapis/">Google APIs Client Libraries</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    Server <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/tutorials/cmdline/">Tutorial: Basic Command-Line Apps</a></li>
                <li><a href="/docs/tutorials/httpserver/">Tutorial: HTTP Servers and Clients</a></li>

                <li class="divider"></li>
                <li><a href="/server/google-cloud-platform/">Deploying Your Server Application</a></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/googleapis/">Using Google APIs from Your Server</a></li>

                <li class="divider"></li>
                <li><a href="/docs/serverguide.html">Additional Resources</a></li>
              </ul>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    More <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>

                <li><a href="/samples/">Code Samples</a></li>
                <li><a href="/docs/synonyms/">Synonyms with Other Languages</a></li>
                <li><a href="/dart-by-example/">Dart by Example</a></li>

                <li class="divider"></li>
                <li><a href="/articles/">Articles</a></li>
                <li><a href="http://api.dartlang.org">API Reference</a></li>
                <li><a href="/docs/spec/">Language Specification</a></li>

                <li class="divider"></li>
                <li><a href="/community/who-uses-dart.html">Who Uses Dart</a></li>
                <li><a href="/support/faq.html">FAQ</a></li>
                <li><a href="/logos/">Logos and Colors</a></li>
                <li><a href="/books/">Books</a></li>
                <li><a href="/performance/">Performance</a></li>

                <li class="divider"></li>
                <li><a href="/slides/">Presentations</a></li>
                <li><a href="/dart-tips/">Dart Tips Videos</a></li>
                <li><a href="/support/">Support</a></li>
              </ul>
            </li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li>
              <form class="navbar-search" action="/search.html" id="cse-search-box">
                <input type="hidden" name="cx" value="011220921317074318178:i4mscbaxtru">
                <input type="hidden" name="ie" value="UTF-8">
                <input type="hidden" name="hl" value="en">
                <input type="search" name="q" class="search-query placeholder-position-fix form-control" id="q" autocomplete="off" placeholder="Search">
              </form>
            </li>
            <li><a href="https://twitter.com/dart_lang" class="btn"><i class="sprite-icon-social-twitter"></i></a></li>
            <li><a href="https://plus.google.com/+dartlang/posts" class="btn"><i class="sprite-icon-social-gplus"></i></a></li>
          </ul>
        </div><!-- /.nav-collapse -->

      </div><!-- /.container -->
    </div><!-- /.navbar -->


<div class="container-page">
  <div class="container">
    <div class="container col-md-10 col-md-offset-1 sub-page">
      <div>
      <div>
<ol class="breadcrumb">

  <li><a href="/server/">
  Dart on the Server</a></li>

  <li><a href="/server/google-cloud-platform/">
  Google Cloud Platform</a></li>

  <li><a href="/server/google-cloud-platform/app-engine/">
  App Engine</a></li>

  <li><a href="/server/google-cloud-platform/app-engine/client-server/">
  Client-Server Example</a></li>


  <li class="active">Server Code</li>
</ol>
</div>

<h1 id="the-server-code-explained">The Server Code Explained</h1>

<p>This section highlights certain methods from the server code
and describes the lines that are related to App Engine
and its services.</p>

<h3 class="no_toc" id="contents">Contents</h3>

<ol class="toc" id="markdown-toc">
  <li><a href="#accessing-datastore">Accessing the Cloud Database service</a></li>
  <li><a href="#running-runappengine">Running runAppEngine()</a></li>
  <li><a href="#serving-assets">Serving assets</a></li>
  <li><a href="#committing-items-to-the-cloud-datastore">Committing items to the Cloud Datastore</a></li>
  <li><a href="#running-a-query">Running a query</a></li>
  <li><a href="#using-the-rootkey">Using the rootkey</a></li>
  <li><a href="#what-next">What next?</a></li>
</ol>

<h2 id="accessing-datastore">Accessing the Cloud Database service</h2>

<p>You can use <code>context.services</code> to get access
to the App Engine services, such as
Cloud Database, memcache and so on.
For example, here’s how to get a handle
on the Cloud Datastore service:</p>

<pre class="prettyprint lang-dart">
context.services.db
</pre>

<p>From this handle, you can call the service’s methods, such as <code>commit()</code>
and <code>query()</code>.</p>

<pre class="prettyprint lang-dart">
context.services.db.query(...);
</pre>

<h2 id="running-runappengine">Running runAppEngine()</h2>

<p>The <code>main()</code> function calls <code>runAppEngine()</code> to start App Engine
and provides a method, <code>requestHandler()</code> that App Engine calls
for each HTTP request from the client.</p>

<pre class="prettyprint lang-dart">
main() {
  runAppEngine(requestHandler);
}
</pre>

<h2 id="serving-assets">Serving assets</h2>

<p>The <code>requestHandler()</code> method triages the incoming client requests
based on the URI path and handles the special ones accordingly.
If the URI path does not match any of those tested for,
the program calls the highlighted line of code, which
serves client files, such as <code>index.html</code>.
In fact, some of the special URI paths are processed
and then redirected to <code>index.html</code>.</p>

<pre class="prettyprint lang-dart">
void requestHandler(HttpRequest request) {
  if (request.uri.path == &#39;/items&#39;) {
    handleItems(request);
  } else if (request.uri.path == &#39;/clean&#39;) {
    handleClean(request).then((_) {
      request.response.redirect(Uri.parse(&#39;/index.html&#39;));
    });
  } else if (request.uri.path == &#39;/&#39;) {
    request.response.redirect(Uri.parse(&#39;/index.html&#39;));
  } else {
    <code class="nocode highlight">context.assets.serve();</code>
  }
}
</pre>

<p>The <code>context.assets.serve();</code> method fetches the assets either from <code>pub
serve</code> or from the web directory
depending on whether the option <code>--dart-pub-serve</code> is
passed to <code>gcloud app run</code>.
This includes compiled JavaScript when running in non-Dart browsers.</p>

<p>When not using <code>pub serve</code> no transformations occur and only
simple client assets work.</p>

<h2 id="committing-items-to-the-cloud-datastore">Committing items to the Cloud Datastore</h2>

<p>Use the <code>commit()</code> method to commit an item to the datastore.
The <code>commit()</code> method returns a
<a href="http://api.dartlang.org/async/Future.html">Future</a>
to perform the operation asynchronously.</p>

<pre class="prettyprint lang-dart">
handleItems(HttpRequest request) {
  if (request.method == &#39;GET&#39;) {
    // Get items from datastore using the readItems method;
    // send them to client in JSON format.
    ...
  } else if (request.method == &#39;POST&#39;) {
    // Validate request, then commit new item to the datastore.
    ...
        return <code class="nocode highlight">context.services.db.commit</code>(inserts: [item]).then((_) 
  ...
  }   
}       
</pre>

<p>The server’s <code>handleClean()</code> method uses the <code>commit()</code> method to delete
all items from the list:</p>

<pre class="prettyprint lang-dart">
Future handleClean(HttpRequest request) {
  return readItems().then((items) {
    var deletes = items.map((item) =&gt; item.key).toList();
    return <code class="nocode highlight">context.services.db.commit(deletes: deletes);</code>
  });
}
</pre>

<h2 id="running-a-query">Running a query</h2>

<p>The code in the server’s <code>readItems()</code> method
creates a query to retrieve all items in the datastore
associated with the application running from this origin.
It then calls <code>query.run()</code>, which returns a Stream to perform
the operation asynchronously.</p>

<pre class="prettyprint lang-dart">
Future&lt;List&lt;Item&gt;&gt; readItems() {
  // Get items from datastore.
  var query = <code class="nocode highlight">context.services.db.query</code>(
      Item, ancestorKey: rootKey())..order(&#39;name&#39;);
  return <code class="nocode highlight">query.run.toList</code>();
}       
</pre>

<p>The <code>order()</code> methods sorts the returned list in alphabetical order.</p>

<h2 id="using-the-rootkey">Using the rootkey</h2>

<p>The <code>rootKey</code> method is called by <code>handleItems()</code> and <code>readItems()</code> to
add items to the cloud database.
<code>ItemsRoot</code> is defined in the client’s <code>Model.dart</code> file
and identifies the entity group in which to put the item.</p>

<pre class="prettyprint lang-dart">
rootKey() {
  var rootKey = <code class="nocode highlight">context.services.db.emptyKey.append(ItemsRoot, id: 1);</code>
} 
</pre>

<h2 id="what-next">What next?</h2>

<p>It’s time to deploy your application:
<a href="../deploy.html">Deploy a Dart Application on App Engine</a>.</p>


      </div>
    </div>
  </div>
</div>


  <footer class="footer container-full hidden-print">
    <div class="container">
      <div class="row">
        <div class="col-md-5">
          <h3>A new language, with tools and libraries, for SCALABLE web app engineering</h3>
          <p>Dart is an <a href="https://code.google.com/p/dart/">open-source project</a> with contributors from Google and elsewhere.</p>
          <p class="sm">Except as otherwise noted, the content of this page is licensed under the Creative Commons Attribution 3.0 License, and code samples are licensed under the BSD License.</p>
        </div>
        <div class="col-md-2 col-md-offset-1">
          <h4>Popular Topics</h4>
          <ul>
            <li><a href="/polymer/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Polymer.dart</a></li>
            <li><a href="/performance/">Performance</a></li>
            <li><a href="/docs/dart-up-and-running/ch02.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Language tour</a> &amp;
            <a href="/docs/dart-up-and-running/ch03.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">library tour</a></li>
            <li><a href="/samples/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Code samples</a></li>
            <li><a href="/docs/tutorials/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Tutorials</a> &amp;
                <a href="/codelabs/darrrt/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">code lab</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>Resources</h4>
          <ul>
            <li><a href="http://pub.dartlang.org/">Pub packages</a></li>
            <li><a href="/docs/synonyms/">Synonyms with other languages</a></li>
            <li><a href="http://code.google.com/p/dart/issues/list">Dart bugs and feature requests</a></li>
            <li><a href="https://github.com/dart-lang/dartlang.org">www.dartlang.org repo</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>Community</h4>
          <ul>
            <li><a href="/support/">Mailing lists</a></li>
            <li><a href="https://plus.google.com/communities/114566943291919232850">G+ community</a></li>
            <li><a href="https://plus.google.com/+dartlang/posts">G+ announcement group</a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/dart">Stack Overflow</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer> <!-- End footer -->



<script type='text/javascript' src='/bundles/d0739a444baf6bcd9d6405389c2e294f.js'></script>




<link rel='stylesheet' type='text/css' href='/bundles/2afe6beaa026f8648e912263a89be985.css' />


<link href="../styles.css" rel="stylesheet" type="text/css">



</body>
</html>

