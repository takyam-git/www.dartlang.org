<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Product">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>Why Not a Bytecode VM? | Dart: Structured web apps</title>
  <meta property="twitter:account_id" content="376585411" />
  <meta itemprop="name" content="Why Not a Bytecode VM? | Dart: Structured web apps">
  
  <meta itemprop="image" content="https://www.dartlang.org/imgs/dart-logo-wordmark-1200w.png">
  
  <meta itemprop="description" content="This article discusses the trade-offs VMs have to make, and explains why we think that a language VM makes more sense for Dart.">



<!-- making pagespeed insights happy -->
<style>
@font-face {
  font-family: 'Montserrat';
  font-style: normal;
  font-weight: 400;
  src: url(https://themes.googleusercontent.com/static/fonts/montserrat/v4/zhcz-_WihjSQC0oHJ9TCYL3hpw3pgy2gAi-Ip7WPMi0.woff) format('woff');
}
@font-face {
  font-family: 'Montserrat';
  font-style: normal;
  font-weight: 700;
  src: url(https://themes.googleusercontent.com/static/fonts/montserrat/v4/IQHow_FEYlDC4Gzy_m8fcnbFhgvWbfSbdVg11QabG8w.woff) format('woff');
}
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 300;
  src: url(https://themes.googleusercontent.com/static/fonts/roboto/v10/Hgo13k-tfSpn0qi1SFdUfbO3LdcAZYWl9Si6vvxL-qU.woff) format('woff');
}
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 400;
  src: url(https://themes.googleusercontent.com/static/fonts/roboto/v10/CrYjSnGjrRCn0pd9VQsnFOvvDin1pK8aKteLpeZ5c0A.woff) format('woff');
}
</style>

<link rel='stylesheet' type='text/css' href='http://takyam-git.github.io/www.dartlang.org/bundles/96e4b278be2e9b94cffcad9b0b04384c.css' />


  <link rel="author" href="http://takyam-git.github.io/www.dartlang.org/authors/florian-loitsch.html">
  

  <link rel="alternate" type="application/atom+xml" href="http://news.dartlang.org/feeds/posts/default" title="Atom feed">
  <link href="https://plus.google.com/109866369054280216564" rel="publisher">

  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
  <![endif]-->

  <script>

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-49880327-3', 'dartlang.org');
ga('create', 'UA-26406144-4',
    {'cookieDomain': 'dartlang.org',
     'siteSpeedSampleRate': 50,
     'name': 'dartlangTracker'});

ga('send', 'pageview');
ga('dartlangTracker.send', 'pageview');

</script>


  <script async="" defer="" src="http://takyam-git.github.io/www.dartlang.org/survey.g.doubleclick.net/async_survey?site=apno2k33xucna4srya26u4i2ri"></script>

</head>
<body onload="prettyPrint()" data-spy="scroll" data-target=".bs-sidebar">

    <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="dart-developer-summit-reg" style="text-align:center;background-color: hsl(172,67%,80%);">
        <a href="http://takyam-git.github.io/www.dartlang.org/events/2015/summit/">Watch sessions from the first Dart Developer Summit</a>
      </div>
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://takyam-git.github.io/www.dartlang.org/"><i class="sprite-icon-dart-logo"></i></a>
        </div>

        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
           <li class="dropdown">
              <a href="#" class="dropdown=toggle" data-toggle="dropdown">
                Get Started <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">

                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/codelabs/darrrt/">Learn Dart in Minutes</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/downloads/">Download Dart</a></li>
              </ul>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    Fundamentals <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/dart-up-and-running/ch02.html">Language Tour</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/dart-up-and-running/ch03.html">Library Tour</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/">Programmer's Guide</a></li>

                <li class="divider"></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/tools/">Dart Tools</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/tools/pub/">Pub Package and Asset Manager</a></li>

                <li class="divider"></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/get-started/">Tutorial: Get Started</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/shared-pkgs/">Tutorial: Packages</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/futures/">Tutorial: Async</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    Browser<span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/polymer/">Polymer</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/codelabs/polymer/">Polymer Code Lab</a></li>
                <li class="divider"></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/connect-dart-html/">Tutorial: HTML</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/polymer-intro/">Tutorial: Polymer</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/fetchdata/">Tutorial: Forms & Data</a></li>
                <li class="divider"></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/tools/editor/mobile.html">Mobile</a></li>

                <li class="divider"></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/googleapis/">Google APIs Client Libraries</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    Server <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/cmdline/">Tutorial: Basic Command-Line Apps</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/httpserver/">Tutorial: HTTP Servers and Clients</a></li>

                <li class="divider"></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/server/google-cloud-platform/">Deploying Your Server Application</a></li>
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/googleapis/">Using Google APIs from Your Server</a></li>

                <li class="divider"></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/serverguide.html">Additional Resources</a></li>
              </ul>
            </li>

            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                    More <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>

                <li><a href="http://takyam-git.github.io/www.dartlang.org/samples/">Code Samples</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/synonyms/">Synonyms with Other Languages</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/dart-by-example/">Dart by Example</a></li>

                <li class="divider"></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/articles/">Articles</a></li>
                <li><a href="http://api.dartlang.org">API Reference</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/spec/">Language Specification</a></li>

                <li class="divider"></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/community/who-uses-dart.html">Who Uses Dart</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/support/faq.html">FAQ</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/logos/">Logos and Colors</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/books/">Books</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/performance/">Performance</a></li>

                <li class="divider"></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/slides/">Presentations</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/dart-tips/">Dart Tips Videos</a></li>
                <li><a href="http://takyam-git.github.io/www.dartlang.org/support/">Support</a></li>
              </ul>
            </li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li>
              <form class="navbar-search" action="/search.html" id="cse-search-box">
                <input type="hidden" name="cx" value="011220921317074318178:i4mscbaxtru">
                <input type="hidden" name="ie" value="UTF-8">
                <input type="hidden" name="hl" value="en">
                <input type="search" name="q" class="search-query placeholder-position-fix form-control" id="q" autocomplete="off" placeholder="Search">
              </form>
            </li>
            <li><a href="https://twitter.com/dart_lang" class="btn"><i class="sprite-icon-social-twitter"></i></a></li>
            <li><a href="https://plus.google.com/+dartlang/posts" class="btn"><i class="sprite-icon-social-gplus"></i></a></li>
          </ul>
        </div><!-- /.nav-collapse -->

      </div><!-- /.container -->
    </div><!-- /.navbar -->


<div class="container-page">
  <div class="container">
  	<div class="container sub-page">
      <div class="row">
        <article><div class="col-md-4">
  <div class="bs-sidebar" data-spy="affix" data-offset-bottom="350" role="complementary">

<ol class="toc nav bs-sidenav" id="markdown-toc">
  <li><a href="#apparent-advantages-of-a-bytecode-vm">Apparent advantages of a bytecode VM</a></li>
  <li><a href="#more-bytecodes">More bytecodes</a></li>
  <li><a href="#its-not-just-bytecode">It’s not just bytecode</a></li>
  <li><a href="#optimizing-for-the-language">Optimizing for the language</a></li>
  <li><a href="#the-line-of-trust">The line of trust</a></li>
  <li><a href="#the-case-emforem-a-language-vm">The case <em>for</em> a language VM</a></li>
  <li><a href="#compiling-to-source">Compiling to source</a></li>
</ol>

  </div>
</div>
<div class="col-md-8">
  <p><!-- Start of content -->
</p>

  <div>
    <ol class="breadcrumb">

  <li><a href="http://takyam-git.github.io/www.dartlang.org/articles/">
  Articles</a></li>


  <li class="active">Why Not a Bytecode VM?</li>
</ol>
  </div>

  <h1 id="why-not-a-bytecode-vm">Why Not a Bytecode VM?</h1>

  <p><em>Written by Florian Loitsch and Bob Nystrom<br />
November 2011</em></p>

  <p>When we released an early preview of Dart we were frequently asked why the
Dart VM is not bytecode based, but instead works on Dart source code directly.
A bytecode VM seems to have a big advantage over a language VM: given a
standardized bytecode format, developers can write in the language of their
choice and then simply compile to the specified bytecodes.</p>

  <p>In this article we will discuss the trade-offs VMs have to make, and explain
why we think that a language VM makes more sense for Dart.</p>

  <h2 id="apparent-advantages-of-a-bytecode-vm">Apparent advantages of a bytecode VM</h2>

  <p>The biggest advantage of a bytecode VM is that it is not restricted to one
input language. The <a href="http://en.wikipedia.org/wiki/JVM">JVM</a>, for
instance, supports a multitude of languages such as
<a href="http://www.scala-lang.org/">Scala</a>,
<a href="http://groovy.codehaus.org/">Groovy</a>,
<a href="http://clojure.org/">Clojure</a>, and, of course,
<a href="http://java.com/">Java</a>.
This does not mean that the JVM is an easy compilation target, though.
The above-mentioned languages have all been designed with the JVM in
mind. For languages that have different requirements than Java, the JVM is a
poor compilation target. It is usually possible to compile them to the JVM, but
their performance is generally not on par with specialized VMs (see
<a href="http://jruby.org">JRuby</a> or
<a href="http://www.mozilla.org/rhino">Rhino</a>).
The reasons for the difficulties are numerous:
for example, the JVM assumes you want classes, single dispatch, inheritance,
and primitives. It assumes you
<a href="http://darksleep.com/player/JavaAndUnsignedTypes.html">don’t need
32-bit unsigned math</a>. If you don’t like the lack of unsigned math, sidestepping
Java and going straight to the bytecode won’t help. If you want true dynamic
dispatch, <a href="http://en.wikipedia.org/wiki/Tail_call">tail call
elimination</a>, or <a href="http://www.gigamonkeys.com/book/beyond-exception-handling-conditions-and-restarts.html">
restartable conditions</a>, you’re stuck. It’s not just that <em>Java</em> lacks
them, the <em>bytecode</em> does too. It’s <em>Java</em> bytecode on the <em>Java</em>
Virtual Machine, after all.</p>

  <h2 id="more-bytecodes">More bytecodes</h2>

  <p>Another advantage of bytecode VMs is that they can evolve by simply
adding new bytecodes (which the JVM is doing
with
<a href="http://java.sun.com/developer/technicalArticles/DynTypeLang/"><code>invokedynamic</code></a>).
However, the cost is increased complexity in the VM.
Worse, seemingly similar features might require different bytecodes. For
instance, in order to support all possible languages a VM needs to support a
multitude of calling conventions: tail calls, optional arguments,
rest arguments, keyed arguments, overloaded methods, and so on.</p>

  <p>Sometimes you can get around “missing” opcodes by compiling to other
existing ones, but often that’s impossible while still getting good
performance. Tail-call elimination, continuations (<code>call/cc</code>), <code>
eval()</code>, floats, and long doubles require specialized opcodes to be fast.
Eventually one ends up with something very close to the native CPU
instructions.</p>

  <p><a href="http://code.google.com/p/nativeclient/">Native Client</a> is an
example of this most generalist approach. It is
already supported in Chrome and is fully language neutral.
If the Dart VM is not flexible enough as
compilation target for your language, consider compiling for Native Client
instead.</p>

  <h2 id="its-not-just-bytecode">It’s not just bytecode</h2>

  <p>There’s more to a VM than the instruction set. If you look at the JVM, it
specifies a class file format,
a concurrency model (in the case of the JVM threads with shared state), class
initialization, and
a bunch of other stuff that nails down semantic choices.</p>

  <p>If you’re building a VM (bytecode or not) from scratch, you have to think
about and make those decisions. If you want at least <em>one</em> language to
be great on that VM, many of your choices will be made to serve that language. For
example, each Dart isolate has its own heap. Even if we had a bytecode VM, it
would assume things worked that way. Adding support for sharing memory across
threads in our VM would be pointless since the one language we know our VM will
run doesn’t use it.</p>

  <h2 id="optimizing-for-the-language">Optimizing for the language</h2>

  <p>If you ask one of the VM guys why a language VM is better than a bytecode VM,
  they’ll tell you
a different but maybe even more important story: performance. Optimization is
often based on being able to take things for granted. A VM tailored for a single
language can take that language for granted and optimize specifically for it.</p>

  <p>For example, V8 internally uses “smis” (“small integers”) to make integer
operations less costly. Other JavaScript engines use similar tricks such as
<a href="http://wingolog.org/archives/2011/05/18/value-representation-in-javascript-implementations">NaN tagging</a> to
similar effect. They do this to help make dynamic languages run fast.</p>

  <p>Meanwhile, JVMs don’t do these optimizations. Since all types are statically
known, the compiler knows exactly how much storage they need and what operations
they support. It can then generate appropriate tight code for those types. This
is fast if your language is statically typed, but if you’re trying to compile a
<em>dynamically typed</em> language to the JVM, it won’t be able to run as fast
as a VM that can assume dynamic typing all the way down and optimize
specifically for that.</p>

  <h2 id="the-line-of-trust">The line of trust</h2>

  <p>Opening up bytecode has another important implication: you’ve moved the
security boundary. When your VM’s input is program source code, it can rely on
the grammar of the language itself to enforce important invariants. If it
allows raw bytecode to walk in the door, the story changes.</p>

  <p>You can craft bytecode sequences that a regular Java compiler would never
emit. When you do, you go off the VM’s beaten path. These non-exercised
code paths likely haven’t been optimized as much and often have more bugs. (Many
JVM exploits that rely on broken
<a href="http://java.sun.com/docs/white/langenv/Security.doc3.html">bytecode
verification</a> could never be generated by a Java compiler.)</p>

  <p>This does not necessarily mean that bytecode VMs are less secure, but they
require additional complexity which makes it much harder.</p>

  <h2 id="the-case-emforem-a-language-vm">The case <em>for</em> a language VM</h2>

  <p>So far, we haven’t given a good reason to exclude bytecode VMs. We have
demonstrated that they don’t bring all the advantages one would expect, but
none of our arguments make them a worse choice than a language VM. The key
argument in <em>favor</em> of a language VM is the development process.</p>

  <p>If you’re writing JavaScript, your “compile
step” is just refreshing the browser. Dart must be equally simple to use.
We want to make
development in the browser a great experience. Not only do we want to keep the
fast ‘edit-refresh-view’ cycle that JavaScript developers love, but
we also want to introduce web developers to the powerful live editing
features that Smalltalk developers pioneered.
Sure, you may minify or do other obfuscation when you deploy, but your core
iteration loop is fast and easy because the engine for your language runs it
directly from source.</p>

  <p>You may ask, “but doesn’t Dart require an explicit compile step to
compile to JavaScript for running in the browser?” Well, yes, but we’re talking
specifically about the native Dart VM here. And we <em>are</em> working to make
the Dart-to-JavaScript side of things as nice of a development experience as we
can. Iteration time matters.</p>

  <h2 id="compiling-to-source">Compiling to source</h2>

  <p>Of course, Scala and <a href="http://research.microsoft.com/en-us/um/cambridge/projects/fsharp/">F#</a> show that a new language can be
developed for an existing VM, but it’s possible to do that without bytecode: you
can compile to source. Right now, if you want a new language that runs in the
browser, compiling to JavaScript is your only option. <a href="https://github.com/jashkenas/coffeescript/wiki">CoffeeScript</a>
is the most prominent example of this today, but there are many others.
Dart itself compiles to JavaScript to
let you use it on browsers that don’t support Dart natively.</p>

  <p>Likewise, if you want a new language that runs on Dart’s native VM, you
  could compile that language to Dart. Doing so will then let your language
  take advantage of all of the optimizations that the VM does when it compiles
  from source to machine code. In other words, Dart <em>is</em> your (highly
  specialized) bytecode.</p>
</div>

    	  </div> <!-- End of content from toc.html -->
        </article>
	  </div>

	
	<ul class="pager hidden-print">
	  <li><a href="http://takyam-git.github.io/www.dartlang.org/articles/">More articles about Dart <i class="glyphicon glyphicon-chevron-up"></i></a></li>
	 </ul>
	 

	</div>
  </div>
</div>


  <footer class="footer container-full hidden-print">
    <div class="container">
      <div class="row">
        <div class="col-md-5">
          <h3>A new language, with tools and libraries, for SCALABLE web app engineering</h3>
          <p>Dart is an <a href="https://code.google.com/p/dart/">open-source project</a> with contributors from Google and elsewhere.</p>
          <p class="sm">Except as otherwise noted, the content of this page is licensed under the Creative Commons Attribution 3.0 License, and code samples are licensed under the BSD License.</p>
        </div>
        <div class="col-md-2 col-md-offset-1">
          <h4>Popular Topics</h4>
          <ul>
            <li><a href="http://takyam-git.github.io/www.dartlang.org/polymer/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Polymer.dart</a></li>
            <li><a href="http://takyam-git.github.io/www.dartlang.org/performance/">Performance</a></li>
            <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/dart-up-and-running/ch02.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Language tour</a> &amp;
            <a href="http://takyam-git.github.io/www.dartlang.org/docs/dart-up-and-running/ch03.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">library tour</a></li>
            <li><a href="http://takyam-git.github.io/www.dartlang.org/samples/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Code samples</a></li>
            <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/tutorials/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Tutorials</a> &amp;
                <a href="http://takyam-git.github.io/www.dartlang.org/codelabs/darrrt/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">code lab</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>Resources</h4>
          <ul>
            <li><a href="http://pub.dartlang.org/">Pub packages</a></li>
            <li><a href="http://takyam-git.github.io/www.dartlang.org/docs/synonyms/">Synonyms with other languages</a></li>
            <li><a href="http://code.google.com/p/dart/issues/list">Dart bugs and feature requests</a></li>
            <li><a href="https://github.com/dart-lang/dartlang.org">www.dartlang.org repo</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>Community</h4>
          <ul>
            <li><a href="http://takyam-git.github.io/www.dartlang.org/support/">Mailing lists</a></li>
            <li><a href="https://plus.google.com/communities/114566943291919232850">G+ community</a></li>
            <li><a href="https://plus.google.com/+dartlang/posts">G+ announcement group</a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/dart">Stack Overflow</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer> <!-- End footer -->



<script type='text/javascript' src='http://takyam-git.github.io/www.dartlang.org/bundles/514ef0286af67b679d4820fd3c90e3ce.js'></script>




<link rel='stylesheet' type='text/css' href='http://takyam-git.github.io/www.dartlang.org/bundles/2afe6beaa026f8648e912263a89be985.css' />






</body>
</html>

